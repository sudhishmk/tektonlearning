# Day 9: Scaling Out - Parallel Execution with `Matrix`
---
## üß† Concept of the Day

Often in CI/CD, you need to perform the same action with slight variations. For example, building your application for multiple architectures (`amd64`, `arm64`), testing against different database versions, or deploying to several environments (`staging`, `qa`).

Instead of creating separate tasks for each variation, Tekton provides the **`matrix`** feature. By adding a `matrix` to a `PipelineTask`, you can define one or more `params` with an array of values. Tekton will then "fan out" the task, generating and executing a `TaskRun` for every possible combination of the parameter values in parallel.

This is a beta feature, so it requires the `enable-api-fields: "beta"` flag in your `feature-flags` `ConfigMap`, which you already enabled on Day 6.

---
## üíº Real-World Use Case

A mobile application team needs to build their app for both iOS and Android and for different configurations like "debug" and "release". They can define a single `build-app` `Task` in their pipeline with a `matrix`:
```yaml
matrix:
  params:
    - name: platform
      value: ["ios", "android"]
    - name: build-config
      value: ["debug", "release"]
```

---
## üíª Code/Config Example

This `Pipeline` uses a `matrix` to run an "echo" `Task` for three different environments in parallel.

**`pipeline.yaml`**
```yaml
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: matrix-demo-pipeline
spec:
  tasks:
    - name: deploy-in-parallel
      taskRef:
        name: echo-message
      matrix:
        params:
          - name: environment
            value: ["staging", "qa", "production"]
      params: # These params are passed to each generated TaskRun
        - name: message
          value: "Deploying to the $(params.environment) environment..."
```

---
## ü§î Daily Self-Assessment

**Question:** If a `Pipeline` `Task` has a `matrix` with two parameters, `paramA: ["x", "y"]` and `paramB: ["1", "2", "3"]`, how many `TaskRuns` will be generated by the matrix?

**Answer:** Six. Tekton creates a `TaskRun` for the Cartesian product (all combinations) of the parameter values (2 * 3 = 6).

---
## üõ†Ô∏è Practical To-do exercise

Today, you'll modify your CI pipeline to simulate parallel deployments to multiple environments after the tests have passed.

1.  **Navigate and Create Directory**:
    ```bash
    cd tekton-learning
    mkdir -p week2/day9
    ```

2.  **Create the Matrix `Pipeline`**: Create `week2/day9/pipeline.yaml`. This pipeline will clone, test, and then "deploy" to a list of environments in parallel using the `matrix` feature.

    ```yaml
    # week2/day9/pipeline.yaml
    apiVersion: tekton.dev/v1beta1
    kind: Pipeline
    metadata:
      name: ci-pipeline-with-matrix
    spec:
      params:
        - name: repo-url
          type: string
      workspaces:
        - name: shared-workspace

      tasks:
        - name: clone-repo
          taskRef:
            name: git-clone
            bundle: gcr.io/tekton-releases/catalog/upstream/git-clone:0.9
          params:
            - name: url
              value: $(params.repo-url)
          workspaces:
            - name: output
              workspace: shared-workspace

        - name: run-go-tests
          runAfter: ["clone-repo"]
          taskRef:
            name: go-test-with-results # Task from Day 8
          workspaces:
            - name: source
              workspace: shared-workspace

        - name: parallel-deploys
          runAfter: ["run-go-tests"]
          taskRef:
            name: echo-message # Generic echo task
          matrix: # <-- The fan-out part!
            params:
              - name: environment
                value: ["staging", "qa-testing"]
              - name: region
                value: ["us-east-1", "eu-west-1"]
          params: # Values passed to each instance of the echo-message task
            - name: message
              value: "üöÄ Deploying to $(params.environment) in region $(params.region)"
    ```

3.  **Create the `PipelineRun`**: Create `week2/day9/pipelinerun.yaml`.
    ```yaml
    # week2/day9/pipelinerun.yaml
    apiVersion: tekton.dev/v1beta1
    kind: PipelineRun
    metadata:
      name: matrix-ci-run-1
    spec:
      pipelineRef:
        name: ci-pipeline-with-matrix
      params:
        - name: repo-url
          value: [https://github.com/YOUR_USERNAME/tekton-learning.git](https://github.com/YOUR_USERNAME/tekton-learning.git) # <-- IMPORTANT: CHANGE THIS
      workspaces:
        - name: shared-workspace
          persistentVolumeClaim:
            claimName: tekton-shared-workspace
    ```
    **Remember to replace `YOUR_USERNAME`.**

4.  **Apply and Run**:
    ```bash
    # Apply the new pipeline definition
    kubectl apply -f week2/day9/pipeline.yaml

    # Run it!
    kubectl apply -f week2/day9/pipelinerun.yaml
    ```

5.  **Verify the Result**:
    * Watch the `PipelineRun`'s status: `kubectl get pipelinerun matrix-ci-run-1 -w`.
    * Once the first two tasks complete, you'll see multiple `TaskRuns` for the `parallel-deploys` step get created.
    * List the `TaskRuns` to see the generated instances:
        ```bash
        kubectl get taskruns | grep matrix-ci-run-1
        ```
        You should see four `TaskRuns` for the `parallel-deploys` step, one for each environment/region combination.
    * Check the logs of one of the generated pods to see its unique message:
        ```bash
        # Find a pod name like matrix-ci-run-1-parallel-deploys-environment-staging-...
        kubectl logs <one-of-the-parallel-deploy-pod-names>
        # You should see: "üöÄ Deploying to staging in region us-east-1"
        ```

6.  **Commit Your Work**:
    ```bash
    git add .
    git commit -m "Day 9: Add Matrix for parallel task execution"
    git push origin main
    ```
